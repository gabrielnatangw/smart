# ========================================
# 🚨 REGRAS DE ALERTA - PROMETHEUS
# ========================================
# Regras de alerta para monitoramento da aplicação

groups:
  # ========================================
  # 🚀 ALERTAS DA APLICAÇÃO
  # ========================================
  - name: backend-api
    rules:
      # Aplicação não está respondendo
      - alert: BackendAPIDown
        expr: up{job="backend-api"} == 0
        for: 1m
        labels:
          severity: critical
          service: backend-api
        annotations:
          summary: 'Backend API está fora do ar'
          description: 'A aplicação backend não está respondendo há mais de 1 minuto'

      # Tempo de resposta alto
      - alert: BackendAPIHighResponseTime
        expr: http_request_duration_seconds{job="backend-api",quantile="0.95"} > 2
        for: 5m
        labels:
          severity: warning
          service: backend-api
        annotations:
          summary: 'Tempo de resposta alto na API'
          description: 'O tempo de resposta 95º percentil está acima de 2 segundos'

      # Taxa de erro alta
      - alert: BackendAPIHighErrorRate
        expr: rate(http_requests_total{job="backend-api",status=~"5.."}[5m]) > 0.1
        for: 5m
        labels:
          severity: critical
          service: backend-api
        annotations:
          summary: 'Taxa de erro alta na API'
          description: 'A taxa de erro 5xx está acima de 10%'

      # Uso de memória alto
      - alert: BackendAPIHighMemoryUsage
        expr: process_resident_memory_bytes{job="backend-api"} > 500 * 1024 * 1024
        for: 5m
        labels:
          severity: warning
          service: backend-api
        annotations:
          summary: 'Uso de memória alto na API'
          description: 'A aplicação está usando mais de 500MB de memória'

      # Uso de CPU alto
      - alert: BackendAPIHighCPUUsage
        expr: rate(process_cpu_seconds_total{job="backend-api"}[5m]) > 0.8
        for: 5m
        labels:
          severity: warning
          service: backend-api
        annotations:
          summary: 'Uso de CPU alto na API'
          description: 'A aplicação está usando mais de 80% de CPU'

  # ========================================
  # 🗄️ ALERTAS DO BANCO DE DADOS
  # ========================================
  - name: postgresql
    rules:
      # PostgreSQL não está respondendo
      - alert: PostgreSQLDown
        expr: up{job="postgres"} == 0
        for: 1m
        labels:
          severity: critical
          service: postgres
        annotations:
          summary: 'PostgreSQL está fora do ar'
          description: 'O banco de dados PostgreSQL não está respondendo'

      # Conexões ativas altas
      - alert: PostgreSQLHighConnections
        expr: pg_stat_database_numbackends{job="postgres"} > 80
        for: 5m
        labels:
          severity: warning
          service: postgres
        annotations:
          summary: 'Muitas conexões ativas no PostgreSQL'
          description: 'O número de conexões ativas está acima de 80'

      # Tamanho do banco alto
      - alert: PostgreSQLHighDatabaseSize
        expr: pg_database_size_bytes{job="postgres"} > 5 * 1024 * 1024 * 1024
        for: 1h
        labels:
          severity: warning
          service: postgres
        annotations:
          summary: 'Tamanho do banco de dados alto'
          description: 'O banco de dados está maior que 5GB'

  # ========================================
  # 🔴 ALERTAS DO REDIS
  # ========================================
  - name: redis
    rules:
      # Redis não está respondendo
      - alert: RedisDown
        expr: up{job="redis"} == 0
        for: 1m
        labels:
          severity: critical
          service: redis
        annotations:
          summary: 'Redis está fora do ar'
          description: 'O cache Redis não está respondendo'

      # Uso de memória alto no Redis
      - alert: RedisHighMemoryUsage
        expr: redis_memory_used_bytes{job="redis"} > 100 * 1024 * 1024
        for: 5m
        labels:
          severity: warning
          service: redis
        annotations:
          summary: 'Uso de memória alto no Redis'
          description: 'O Redis está usando mais de 100MB de memória'

  # ========================================
  # 🌐 ALERTAS DO NGINX
  # ========================================
  - name: nginx
    rules:
      # Nginx não está respondendo
      - alert: NginxDown
        expr: up{job="nginx"} == 0
        for: 1m
        labels:
          severity: critical
          service: nginx
        annotations:
          summary: 'Nginx está fora do ar'
          description: 'O proxy reverso Nginx não está respondendo'

      # Taxa de erro 4xx alta
      - alert: NginxHigh4xxRate
        expr: rate(nginx_http_requests_total{status=~"4.."}[5m]) > 0.1
        for: 5m
        labels:
          severity: warning
          service: nginx
        annotations:
          summary: 'Taxa de erro 4xx alta no Nginx'
          description: 'A taxa de erro 4xx está acima de 10%'

      # Taxa de erro 5xx alta
      - alert: NginxHigh5xxRate
        expr: rate(nginx_http_requests_total{status=~"5.."}[5m]) > 0.05
        for: 5m
        labels:
          severity: critical
          service: nginx
        annotations:
          summary: 'Taxa de erro 5xx alta no Nginx'
          description: 'A taxa de erro 5xx está acima de 5%'

  # ========================================
  # 💾 ALERTAS DE SISTEMA
  # ========================================
  - name: system
    rules:
      # Espaço em disco baixo
      - alert: LowDiskSpace
        expr: (node_filesystem_avail_bytes / node_filesystem_size_bytes) < 0.1
        for: 5m
        labels:
          severity: critical
          service: system
        annotations:
          summary: 'Espaço em disco baixo'
          description: 'O disco {{ $labels.mountpoint }} tem menos de 10% de espaço livre'

      # Uso de memória alto do sistema
      - alert: HighSystemMemoryUsage
        expr: (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) > 0.9
        for: 5m
        labels:
          severity: warning
          service: system
        annotations:
          summary: 'Uso de memória alto do sistema'
          description: 'O sistema está usando mais de 90% da memória disponível'

      # Uso de CPU alto do sistema
      - alert: HighSystemCPUUsage
        expr: 100 - (avg by(instance) (rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 80
        for: 5m
        labels:
          severity: warning
          service: system
        annotations:
          summary: 'Uso de CPU alto do sistema'
          description: 'O sistema está usando mais de 80% de CPU'
