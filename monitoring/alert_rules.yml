# ========================================
# ðŸš¨ REGRAS DE ALERTA - PROMETHEUS
# ========================================
# Regras de alerta para monitoramento da aplicaÃ§Ã£o

groups:
  # ========================================
  # ðŸš€ ALERTAS DA APLICAÃ‡ÃƒO
  # ========================================
  - name: backend-api
    rules:
      # AplicaÃ§Ã£o nÃ£o estÃ¡ respondendo
      - alert: BackendAPIDown
        expr: up{job="backend-api"} == 0
        for: 1m
        labels:
          severity: critical
          service: backend-api
        annotations:
          summary: 'Backend API estÃ¡ fora do ar'
          description: 'A aplicaÃ§Ã£o backend nÃ£o estÃ¡ respondendo hÃ¡ mais de 1 minuto'

      # Tempo de resposta alto
      - alert: BackendAPIHighResponseTime
        expr: http_request_duration_seconds{job="backend-api",quantile="0.95"} > 2
        for: 5m
        labels:
          severity: warning
          service: backend-api
        annotations:
          summary: 'Tempo de resposta alto na API'
          description: 'O tempo de resposta 95Âº percentil estÃ¡ acima de 2 segundos'

      # Taxa de erro alta
      - alert: BackendAPIHighErrorRate
        expr: rate(http_requests_total{job="backend-api",status=~"5.."}[5m]) > 0.1
        for: 5m
        labels:
          severity: critical
          service: backend-api
        annotations:
          summary: 'Taxa de erro alta na API'
          description: 'A taxa de erro 5xx estÃ¡ acima de 10%'

      # Uso de memÃ³ria alto
      - alert: BackendAPIHighMemoryUsage
        expr: process_resident_memory_bytes{job="backend-api"} > 500 * 1024 * 1024
        for: 5m
        labels:
          severity: warning
          service: backend-api
        annotations:
          summary: 'Uso de memÃ³ria alto na API'
          description: 'A aplicaÃ§Ã£o estÃ¡ usando mais de 500MB de memÃ³ria'

      # Uso de CPU alto
      - alert: BackendAPIHighCPUUsage
        expr: rate(process_cpu_seconds_total{job="backend-api"}[5m]) > 0.8
        for: 5m
        labels:
          severity: warning
          service: backend-api
        annotations:
          summary: 'Uso de CPU alto na API'
          description: 'A aplicaÃ§Ã£o estÃ¡ usando mais de 80% de CPU'

  # ========================================
  # ðŸ—„ï¸ ALERTAS DO BANCO DE DADOS
  # ========================================
  - name: postgresql
    rules:
      # PostgreSQL nÃ£o estÃ¡ respondendo
      - alert: PostgreSQLDown
        expr: up{job="postgres"} == 0
        for: 1m
        labels:
          severity: critical
          service: postgres
        annotations:
          summary: 'PostgreSQL estÃ¡ fora do ar'
          description: 'O banco de dados PostgreSQL nÃ£o estÃ¡ respondendo'

      # ConexÃµes ativas altas
      - alert: PostgreSQLHighConnections
        expr: pg_stat_database_numbackends{job="postgres"} > 80
        for: 5m
        labels:
          severity: warning
          service: postgres
        annotations:
          summary: 'Muitas conexÃµes ativas no PostgreSQL'
          description: 'O nÃºmero de conexÃµes ativas estÃ¡ acima de 80'

      # Tamanho do banco alto
      - alert: PostgreSQLHighDatabaseSize
        expr: pg_database_size_bytes{job="postgres"} > 5 * 1024 * 1024 * 1024
        for: 1h
        labels:
          severity: warning
          service: postgres
        annotations:
          summary: 'Tamanho do banco de dados alto'
          description: 'O banco de dados estÃ¡ maior que 5GB'

  # ========================================
  # ðŸ”´ ALERTAS DO REDIS
  # ========================================
  - name: redis
    rules:
      # Redis nÃ£o estÃ¡ respondendo
      - alert: RedisDown
        expr: up{job="redis"} == 0
        for: 1m
        labels:
          severity: critical
          service: redis
        annotations:
          summary: 'Redis estÃ¡ fora do ar'
          description: 'O cache Redis nÃ£o estÃ¡ respondendo'

      # Uso de memÃ³ria alto no Redis
      - alert: RedisHighMemoryUsage
        expr: redis_memory_used_bytes{job="redis"} > 100 * 1024 * 1024
        for: 5m
        labels:
          severity: warning
          service: redis
        annotations:
          summary: 'Uso de memÃ³ria alto no Redis'
          description: 'O Redis estÃ¡ usando mais de 100MB de memÃ³ria'

  # ========================================
  # ðŸŒ ALERTAS DO NGINX
  # ========================================
  - name: nginx
    rules:
      # Nginx nÃ£o estÃ¡ respondendo
      - alert: NginxDown
        expr: up{job="nginx"} == 0
        for: 1m
        labels:
          severity: critical
          service: nginx
        annotations:
          summary: 'Nginx estÃ¡ fora do ar'
          description: 'O proxy reverso Nginx nÃ£o estÃ¡ respondendo'

      # Taxa de erro 4xx alta
      - alert: NginxHigh4xxRate
        expr: rate(nginx_http_requests_total{status=~"4.."}[5m]) > 0.1
        for: 5m
        labels:
          severity: warning
          service: nginx
        annotations:
          summary: 'Taxa de erro 4xx alta no Nginx'
          description: 'A taxa de erro 4xx estÃ¡ acima de 10%'

      # Taxa de erro 5xx alta
      - alert: NginxHigh5xxRate
        expr: rate(nginx_http_requests_total{status=~"5.."}[5m]) > 0.05
        for: 5m
        labels:
          severity: critical
          service: nginx
        annotations:
          summary: 'Taxa de erro 5xx alta no Nginx'
          description: 'A taxa de erro 5xx estÃ¡ acima de 5%'

  # ========================================
  # ðŸ’¾ ALERTAS DE SISTEMA
  # ========================================
  - name: system
    rules:
      # EspaÃ§o em disco baixo
      - alert: LowDiskSpace
        expr: (node_filesystem_avail_bytes / node_filesystem_size_bytes) < 0.1
        for: 5m
        labels:
          severity: critical
          service: system
        annotations:
          summary: 'EspaÃ§o em disco baixo'
          description: 'O disco {{ $labels.mountpoint }} tem menos de 10% de espaÃ§o livre'

      # Uso de memÃ³ria alto do sistema
      - alert: HighSystemMemoryUsage
        expr: (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) > 0.9
        for: 5m
        labels:
          severity: warning
          service: system
        annotations:
          summary: 'Uso de memÃ³ria alto do sistema'
          description: 'O sistema estÃ¡ usando mais de 90% da memÃ³ria disponÃ­vel'

      # Uso de CPU alto do sistema
      - alert: HighSystemCPUUsage
        expr: 100 - (avg by(instance) (rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 80
        for: 5m
        labels:
          severity: warning
          service: system
        annotations:
          summary: 'Uso de CPU alto do sistema'
          description: 'O sistema estÃ¡ usando mais de 80% de CPU'
