name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_run:
    workflows: ['Build and Deploy Docker Image']
    types: [completed]
    branches: [main]

jobs:
  deploy-production:
    if: ${{ github.ref == 'refs/heads/main' && github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Deploy para Produção
        run: |
          echo "🚀 Deployando para PRODUÇÃO..."
          echo "📦 Imagem: ghcr.io/${{ github.repository_owner }}/${{ github.event.repository.name }}:main"
          echo "🌍 Ambiente: Produção"
          echo "📦 Container: smart-v2-backend-prod"
          echo "🌐 Portas: 3000-3001:3000-3001"
          echo ""
          echo "📋 Comando de deploy:"
          echo "docker run -d \\"
          echo "  --name smart-v2-backend-prod \\"
          echo "  -p 3000-3001:3000-3001 \\"
          echo "  --restart unless-stopped \\"
          echo "  -e NODE_ENV=production \\"
          echo "  -e USE_CLOUD_SQL=true \\"
          echo "  -e INSTANCE_CONNECTION_NAME=smart-201703:us-central1:smart-platform \\"
          echo "  -e PROD_DB_DATABASE=smart-prod \\"
          echo "  ghcr.io/${{ github.repository_owner }}/${{ github.event.repository.name }}:main"
          echo ""
          echo "✅ Deploy configurado para PRODUÇÃO!"

      - name: Notificar Deploy
        run: |
          echo "📢 Notificação de Deploy Produção"
          echo "🕐 Timestamp: $(date)"
          echo "🔗 Commit: ${{ github.sha }}"
          echo "👤 Autor: ${{ github.actor }}"
          echo "🌿 Branch: main"
